
<?php header('Access-Control-Allow-Origin: *'); ?>
<!DOCTYPE HTML>
<html>
    <head>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <script>




            function getRoster(){
                $.ajax({
                    url: "https://orgtmetrics.herokuapp.com/roster",
                    type: 'GET',
                    dataType: 'JSON',
                    beforeSend: function(){
                        //this will be triggered before sending the ajax request
                        console.log('Sending AJAX Request...');
                    },
                    success: function(response){
                        //this will be triggered when the request successfully gets completed
                        //console.log(response.User);
                        generateChart(response.User, "All ORGT Members")
                        sports = parseDataBySport(response)
                        console.log(sports)
                        keys = Object.keys(sports)
                        //for (sport in keys) {
                        //    generateChart(sports[sport], sport)
                        //}
                        generateChart(sports["Sea Kayaking"], "Sea Kayaking")
                        
                    },
                    error: function(){
                        //this will be triggered when the request fails 
                        console.log('Request Failed.');
                    }
                });
            }

            function generateChart(response, name) {
                dataPoints = getDataPoints(response, 'IIT MOU Signed', 'Grad Date')
                //console.log(dataPoints)
                dataPoints2 = getDataPoints(response, 'Ins MOU Signed', 'Grad Date')
                dataPoints3 = getDataPoints(response, 'TL MOU Signed', 'Grad Date')
                dataPoints4 = getDataPoints(response, 'STL Promotion', 'Grad Date')

                dataPoints = subtractDataVals(dataPoints, dataPoints2)
                //console.log(dataPoints)
                dataPoints2 = subtractDataVals(dataPoints2, dataPoints3)
                //console.log(dataPoints2)
                dataPoints3 = subtractDataVals(dataPoints3, dataPoints4)
                //console.log(dataPoints3)

                data = [
                    {
                        type: "line",
                        dataPoints: dataPoints,
                        name: "Instructors in Training",
                        showInLegend: true
                    },
                    {
                        type: "line",
                        dataPoints: dataPoints2,
                        name: "Instructors",
                        showInLegend: true
                    },
                    {
                        type: "line",
                        dataPoints: dataPoints3,
                        name: "Trip Leads",
                        showInLegend: true
                    }, 
                    {
                        type: "line",
                        dataPoints: dataPoints4,
                        name: "Senior Trip Leads",
                        showInLegend: true
                    }
                ];

                //chartDiv = document.createElement("div")
                //chartDiv.setAttribute('id', name)


                var chart = new CanvasJS.Chart("chartContainer", {
                    animationEnabled: true,
                    theme: "light2",
                    title:{
                        text: name                            },
                    axisY:{
                        includeZero: false
                    },
                    data: data
                });



                chart.render();
            }




            function dateDistance(date1, date2){
                var yearDif = date1.getFullYear() - date2.getFullYear()
                var monthDif = date1.getMonth() - date2.getMonth()
                return yearDif * 12 + monthDif
            }

            function getDataPoints(response, start_classifier, end_classifier) {
                //console.log("begins method")
                var monthHead = new Date()
                var monthList = []
                var dataPoints = []
                
                for(var i in response) {
                    if (response[i][start_classifier] != "" && response[i][end_classifier] != ""){
                        start = new Date(response[i][start_classifier])
                        end = new Date(response[i][end_classifier])
                        //console.log(dateDistance(start, monthHead))
                        if (dateDistance(start, monthHead) < 0){
                            var expands = dateDistance(monthHead, start)
                            for (var i = 0; i < expands; i++){
                                monthList.unshift(0)
                            }
                            monthHead = start
                        }
                        var startInd = dateDistance(start, monthHead)
                        var endInd = dateDistance(end, monthHead)
                        //console.log(startInd)
                        //console.log(endInd)
                        expands = endInd - monthList.length
                        for (var i = 0; i < expands; i++) {
                            monthList.push(0)
                        }
                        for (var i = startInd; i <= endInd; i++) {
                            monthList[i] = monthList[i] + 1
                        }

                    }
                }
                //console.log(monthList)

                for (var i = 0; i < monthList.length; i++) {
                    var monthDate = new Date()
                    monthDate.setDate(1)
                    monthDate.setMonth((monthHead.getMonth() + i) % 12)
                    monthDate.setYear((monthHead.getFullYear())+ ((monthHead.getMonth() + i)/12))
                    dataPoints.push({x: monthDate, y: monthList[i]})
                }
                //console.log(dataPoints)
                return dataPoints;
            }

            //A - B assume B c A
            function subtractDataVals(pointsA, pointsB) {
                var counter = 0
                var newDataPoints = []
                for (var i = 0; i < pointsA.length; i++) {
                    if (counter >= pointsB.length) {
                        newDataPoints.push(pointsA[i])
                    } else {
                        var a = pointsA[i]['x']
                        //console.log(a)
                        var b = pointsB[counter]['x']
                        //console.log(b)
                        if (a.getMonth() == b.getMonth() && a.getFullYear() == b.getFullYear()) {
                            newDataPoints.push({x: a, y: pointsA[i]['y'] - pointsB[counter]['y']})
                            counter = counter + 1
                        } else {
                            newDataPoints.push(pointsA[i])
                        }
                    }
                }
                return newDataPoints
            }

            function parseDataBySport(response) {
                sports = {}
                for (var i in response.User) {
                    var sport = response.User[i]['Sport']
                    if (sport != "") {
                        //console.log(Object.keys(sports))
                        var keys = Object.keys(sports)
                        //console.log(sport in keys)
                        //console.log(typeof sports[sport])
                        if (typeof sports[sport] === "object") {
                            //console.log(sports[sport])
                            var holder = sports[sport]
                            holder.push(response.User[i])
                            sports[sport] = holder
                            //console.log(sports[sport])
                        } else {
                            sports[sport] = [response.User[i]]
                        }

                    }
                }
                return sports
            }

            window.onload = function() {

                getRoster();
            };






        </script>

        <!--<script>
            window.onload = function () {

                data =  [{
                        type: "line",
                        dataPoints: [
                            { y: 450 },
                            { y: 414},
                            { y: 520, indexLabel: "highest",markerColor: "red", markerType: "triangle" },
                            { y: 460 },
                            { y: 450 },
                            { y: 500 },
                            { y: 480 },
                            { y: 480 },
                            { y: 410 , indexLabel: "lowest",markerColor: "DarkSlateGrey", markerType: "cross" },
                            { y: 500 },
                            { y: 480 },
                            { y: 510 }
                        ]},{
                        type: "line",
                        dataPoints:[
                            { y: 10 },
                            { y: 20},
                            { y: 10, indexLabel: "highest",markerColor: "red", markerType: "triangle" },
                            { y: 20 },
                            { y: 30 },
                            { y: 40 },
                            { y: 50 },
                            { y: 60 },
                            { y: 70 , indexLabel: "lowest",markerColor: "DarkSlateGrey", markerType: "cross" },
                            { y: 80 },
                            { y: 90 },
                            { y: 100 }
                        ]}

                    ];

                var chart = new CanvasJS.Chart("chartContainer", {
                	animationEnabled: true,
                	theme: "light2",
                	title:{
                		text: "Simple Line Chart"
                	},
                	axisY:{
                		includeZero: false
                	},
                	data: data
                });
                chart.render();
            }

            function PopulateAll(){
                $.ajax({
                url: "https://orgtmetrics.herokuapp.com/roster",
                type: 'GET',
                dataType: 'JSON',
                beforeSend: function(){
                //this will be triggered before sending the ajax request
                console.log('Sending AJAX Request...');
                },
                success: function(response){
                //this will be triggered when the request successfully gets completed
                console.log(response);
                },
                error: function(){
                //this will be triggered when the request fails
                console.log('Request Failed.');
                }
                });
            }

            PopulateAll();
        -->




        </script>
    </head>
    <body>
        <div id="chartContainer" style="height: 300px; width: 100%;"></div>
        <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
    </body>
</html>
