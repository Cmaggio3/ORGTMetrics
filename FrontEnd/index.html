
<?php header('Access-Control-Allow-Origin: *'); ?>
<!DOCTYPE HTML>
<html>
    <head>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <script>




            function getRoster(){
                $.ajax({
                    url: "https://orgtmetrics.herokuapp.com/roster",
                    type: 'GET',
                    dataType: 'JSON',
                    beforeSend: function(){
                        //this will be triggered before sending the ajax request
                        console.log('Sending AJAX Request...');
                    },
                    success: function(response){
                        //this will be triggered when the request successfully gets completed
                        //console.log(response.User);
                        generateChart(response.User, "All ORGT Members")
                        sports = parseDataBySport(response)
                        //console.log(sports)
                        keys = Object.keys(sports)
                        //console.log(keys)
                        for (sport in keys) {
                            generateChart(sports[keys[sport]], keys[sport])
                        }
                        //generateChart(sports["Sea Kayaking"], "Sea Kayaking")
                        
                    },
                    error: function(){
                        //this will be triggered when the request fails 
                        console.log('Request Failed.');
                    }
                });
            }

            function generateChart(response, name) {
                var dataPoints = getDataPoints(response, 'IIT MOU Signed', 'Final Date')
                //console.log(name)
                //console.log(dataPoints)

                if (dataPoints.length <= 0) {
                    return
                }
                var dataPoints2 = getDataPoints(response, 'Ins MOU Signed', 'Final Date')
                var dataPoints3 = getDataPoints(response, 'TL MOU Signed', 'Final Date')
                var dataPoints4 = getDataPoints(response, 'STL Promotion', 'Final Date')

                dataPoints = subtractDataVals(dataPoints, dataPoints2)
                //console.log(dataPoints)
                dataPoints2 = subtractDataVals(dataPoints2, dataPoints3)
                //console.log(dataPoints2)
                dataPoints3 = subtractDataVals(dataPoints3, dataPoints4)
                //console.log(dataPoints3)
                now1 = getCurrentMonthIndex(dataPoints)
                now2 = getCurrentMonthIndex(dataPoints2)
                now3 = getCurrentMonthIndex(dataPoints3)
                now4 = getCurrentMonthIndex(dataPoints4)
                m1 = Math.max(dataPoints.length - now1, dataPoints2.length -now2)
                m2 = Math.max(dataPoints3.length - now3, dataPoints4.length - now4)
                m = Math.max(m1, m2)
                m = Math.min(m, 48)


                var expectationPoints = steadyMembersOutlook(dataPoints, 36, m)
                //console.log(expectationPoints)
                var expectationPoints2 = steadyMembersOutlook(dataPoints2, 36, m)
                var expectationPoints3 = steadyMembersOutlook(dataPoints3, 36, m)
                var expectationPoints4 = steadyMembersOutlook(dataPoints4, 36, m)
                

                data = [
                    {
                        type: "line",
                        dataPoints: dataPoints,
                        name: "Instructors in Training",
                        showInLegend: true,
                    },
                    {
                        type: "line",
                        dataPoints: dataPoints2,
                        name: "Instructors",
                        showInLegend: true
                    },
                    {
                        type: "line",
                        dataPoints: dataPoints3,
                        name: "Trip Leads",
                        showInLegend: true
                    }, 
                    {
                        type: "line",
                        dataPoints: dataPoints4,
                        name: "Senior Trip Leads",
                        showInLegend: true
                    }, 
                    {
                        type: "line",
                        dataPoints: expectationPoints,
                        name: "Needed IIT's",
                        showInLegend: true,
                        lineDashType: "dash",
                    }, 
                    {
                        type: "line",
                        dataPoints: expectationPoints2,
                        name: "Needed Instructors",
                        showInLegend: true,
                        lineDashType: "dash",
                    }, 
                    {
                        type: "line",
                        dataPoints: expectationPoints3,
                        name: "Needed TL's",
                        showInLegend: true,
                        lineDashType: "dash",
                    }, 
                    {
                        type: "line",
                        dataPoints: expectationPoints4,
                        name: "Needed STL's",
                        showInLegend: true,
                        lineDashType: "dash",
                    }
                ];

                chartDiv = document.createElement("div")
                chartDiv.setAttribute('id', name)
                chartDiv.setAttribute('class', "child")
                chartDiv.setAttribute('style', "height: 300px; width: 100%;")
                document.getElementById("big").appendChild(chartDiv);


                var chart = new CanvasJS.Chart(name, {
                    animationEnabled: true,
                    theme: "light2",
                    title:{
                        text: name                            },
                    axisY:{
                        includeZero: false
                    },
                    data: data
                });



                chart.render();

                var diffName = name + " Differences"
                var diffData = [dataPoints, dataPoints2, dataPoints3, dataPoints4]
                var diffExpect = [expectationPoints, expectationPoints2, expectationPoints3, expectationPoints4]

                generateDifferenceGraph(diffData, diffExpect, diffName)
            }




            function dateDistance(date1, date2){
                var yearDif = date1.getFullYear() - date2.getFullYear()
                var monthDif = date1.getMonth() - date2.getMonth()
                return yearDif * 12 + monthDif
            }

            function getDataPoints(response, start_classifier, end_classifier) {
                //console.log("begins method")
                var monthHead = new Date()
                var monthList = []
                var dataPoints = []
                
                for(var i in response) {
                    if (response[i][start_classifier] != "" && response[i][end_classifier] != ""){
                        start = new Date(response[i][start_classifier])
                        end = new Date(response[i][end_classifier])
                        //console.log(dateDistance(start, monthHead))
                        if (dateDistance(start, monthHead) < 0){
                            var expands = dateDistance(monthHead, start)
                            for (var i = 0; i < expands; i++){
                                monthList.unshift(0)
                            }
                            monthHead = start
                        }
                        var startInd = dateDistance(start, monthHead)
                        var endInd = dateDistance(end, monthHead)
                        //console.log(startInd)
                        //console.log(endInd)
                        expands = endInd - monthList.length
                        for (var i = 0; i < expands; i++) {
                            monthList.push(0)
                        }
                        for (var i = startInd; i <= endInd; i++) {
                            monthList[i] = monthList[i] + 1
                        }

                    }
                }
                //console.log(monthList)

                for (var i = 0; i < monthList.length; i++) {
                    var monthDate = new Date()
                    monthDate.setDate(1)
                    monthDate.setMonth((monthHead.getMonth() + i) % 12)
                    monthDate.setYear((monthHead.getFullYear())+ ((monthHead.getMonth() + i)/12))
                    dataPoints.push({x: monthDate, y: monthList[i]})
                }
                //console.log(dataPoints)
                return dataPoints;
            }

            //A - B assume B c A
            function subtractDataVals(pointsA, pointsB) {
                var counter = 0
                var newDataPoints = []
                for (var i = 0; i < pointsA.length; i++) {
                    if (counter >= pointsB.length) {
                        newDataPoints.push(pointsA[i])
                    } else {
                        var a = pointsA[i]['x']
                        //console.log(a)
                        var b = pointsB[counter]['x']
                        //console.log(b)
                        if (a.getMonth() == b.getMonth() && a.getFullYear() == b.getFullYear()) {
                            newDataPoints.push({x: a, y: pointsA[i]['y'] - pointsB[counter]['y']})
                            counter = counter + 1
                        } else {
                            newDataPoints.push(pointsA[i])
                        }
                    }
                }
                return newDataPoints
            }

            function parseDataBySport(response) {
                sports = {}
                for (var i in response.User) {
                    var sport = response.User[i]['Sport']
                    if (sport != "") {
                        //console.log(Object.keys(sports))
                        var keys = Object.keys(sports)
                        //console.log(sport in keys)
                        //console.log(typeof sports[sport])
                        if (typeof sports[sport] === "object") {
                            //console.log(sports[sport])
                            var holder = sports[sport]
                            holder.push(response.User[i])
                            sports[sport] = holder
                            //console.log(sports[sport])
                        } else {
                            sports[sport] = [response.User[i]]
                        }

                    }
                }
                return sports
            }
            //where p is the number of months we would like to look in the past
            function steadyMembersOutlook(dataPoints, p, f) {
                //console.log(dataPoints)
                var now = getCurrentMonthIndex(dataPoints)
                if (now == -1) {
                    return
                }
                //console.log(now)
                var count = 0
                var sum = 0
                var max = Math.max(0, now - p);
                for (var i = max; i <= now; i++) {
                    sum += dataPoints[i]['y'] 
                    count = i + 1
                }
                //console.log(sum)
                //console.log(count)
                var avg = Math.floor(sum/Math.min(p, now))
                var expectationPoints = []
                var temp = dataPoints[now]['x']
                for (var i = now; i < f + dataPoints.length; i++) {
                    //console.log(dataPoints[i])
                    if (i < dataPoints) {
                        temp = dataPoints[i]['x']
                        expectationPoints.push({x: temp, y: avg})
                    } else {
                        monthDate = new Date()
                        monthDate.setDate(1)
                        monthDate.setMonth((temp.getMonth() + 1) % 12)
                        monthDate.setYear((temp.getFullYear())+ ((temp.getMonth() + 1)/12))
                        expectationPoints.push({x: monthDate, y: avg})
                        temp = monthDate

                    }
                }
                return expectationPoints
            }

            function getCurrentMonthIndex(dataPoints) {
                var now = new Date();
                for (var i = 0; i < dataPoints.length; i++) {
                    var examine = dataPoints[i]['x'];
                    var month = examine.getMonth() == now.getMonth()
                    var year = examine.getFullYear() == now.getFullYear()
                    //console.log("month")
                    //console.log(month)
                    //console.log("year")
                    //console.log(year)
                    if (month && year) {
                        return i;
                    }
                }
                return -1
            }

            //assume length of both is 4
            function generateDifferenceGraph(dataPointsArray, expectationPointsArray, name) {
                if (dataPointsArray.length != 4 || expectationPointsArray.length != 4) {
                    return
                }
                differencePoints1 = generateDifferencePoints(dataPointsArray[0], expectationPointsArray[0], getCurrentMonthIndex(dataPointsArray[0]))
                differencePoints2 = generateDifferencePoints(dataPointsArray[1], expectationPointsArray[1], getCurrentMonthIndex(dataPointsArray[1]))
                differencePoints3 = generateDifferencePoints(dataPointsArray[2], expectationPointsArray[2], getCurrentMonthIndex(dataPointsArray[2]))
                differencePoints4 = generateDifferencePoints(dataPointsArray[0], expectationPointsArray[2], getCurrentMonthIndex(dataPointsArray[2]))
                data = [
                    {
                        type: "line",
                        dataPoints: differencePoints1,
                        name: "Instructors in Training Difference",
                        showInLegend: true,
                    },
                    {
                        type: "line",
                        dataPoints: differencePoints2,
                        name: "Instructors Difference",
                        showInLegend: true
                    },
                    {
                        type: "line",
                        dataPoints: differencePoints3,
                        name: "Trip Leads Difference",
                        showInLegend: true
                    }, 
                    {
                        type: "line",
                        dataPoints: differencePoints4,
                        name: "Senior Trip Leads Difference",
                        showInLegend: true
                    }
                ];
                chartDiv = document.createElement("div")
                chartDiv.setAttribute('id', name)
                chartDiv.setAttribute('class', "child")
                chartDiv.setAttribute('style', "height: 300px; width: 100%;")
                document.getElementById("big").appendChild(chartDiv);


                var chart = new CanvasJS.Chart(name, {
                    animationEnabled: true,
                    theme: "light2",
                    title:{
                        text: name                            },
                    axisY:{
                        includeZero: false
                    },
                    data: data
                });



                chart.render();
            }

            function generateDifferencePoints(dataPoints, expectationPoints, nowI) {
                differencePoints = []
                counter = nowI
                //console.log(dataPoints)
                //console.log(expectationPoints)
                if (expectationPoints == undefined || dataPoints == undefined) {
                    return differencePoints
                }
                for (var i = 0; i < expectationPoints.length; i++) {
                    if (counter < dataPoints.length) {
                        differencePoints.push({x: expectationPoints[i]['x'], y: expectationPoints[i]['y'] - dataPoints[counter]['y']})
                    } else {
                        differencePoints.push({x: expectationPoints[i]['x'], y: expectationPoints[i]['y']})
                    }
                    counter++;
                }
                //console.log(differencePoints)
                return differencePoints
            }

            window.onload = function() {

                getRoster();
            };






        </script>

        <!--<script>
            window.onload = function () {

                data =  [{
                        type: "line",
                        dataPoints: [
                            { y: 450 },
                            { y: 414},
                            { y: 520, indexLabel: "highest",markerColor: "red", markerType: "triangle" },
                            { y: 460 },
                            { y: 450 },
                            { y: 500 },
                            { y: 480 },
                            { y: 480 },
                            { y: 410 , indexLabel: "lowest",markerColor: "DarkSlateGrey", markerType: "cross" },
                            { y: 500 },
                            { y: 480 },
                            { y: 510 }
                        ]},{
                        type: "line",
                        dataPoints:[
                            { y: 10 },
                            { y: 20},
                            { y: 10, indexLabel: "highest",markerColor: "red", markerType: "triangle" },
                            { y: 20 },
                            { y: 30 },
                            { y: 40 },
                            { y: 50 },
                            { y: 60 },
                            { y: 70 , indexLabel: "lowest",markerColor: "DarkSlateGrey", markerType: "cross" },
                            { y: 80 },
                            { y: 90 },
                            { y: 100 }
                        ]}

                    ];

                var chart = new CanvasJS.Chart("chartContainer", {
                	animationEnabled: true,
                	theme: "light2",
                	title:{
                		text: "Simple Line Chart"
                	},
                	axisY:{
                		includeZero: false
                	},
                	data: data
                });
                chart.render();
            }

            function PopulateAll(){
                $.ajax({
                url: "https://orgtmetrics.herokuapp.com/roster",
                type: 'GET',
                dataType: 'JSON',
                beforeSend: function(){
                //this will be triggered before sending the ajax request
                console.log('Sending AJAX Request...');
                },
                success: function(response){
                //this will be triggered when the request successfully gets completed
                console.log(response);
                },
                error: function(){
                //this will be triggered when the request fails
                console.log('Request Failed.');
                }
                });
            }

            PopulateAll();
        -->




        </script>
    </head>
    <body>
        <div id = "big">
            <!--<div id="chartContainer" style="height: 300px; width: 100%;"></div> -->
            <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
        </div>
    </body>
</html>
